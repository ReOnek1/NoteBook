![[硬盘.png]]

## 磁盘IO耗时
1. 首先是磁头移动寻找数据所在的磁道：==寻道时间==
2. 然后再盘面旋转，寻找到对应的扇区： ==旋转延迟==
3. 向目标扇区读取或者写入数据： ==存取时间==
---

### 操作系统如何降低随机读写的性能

- 通过按磁道对应的柱面划分分区，降低寻道时间

## 文件系统
#### 文件和目录创建所需资源

- 文件和目录的创建都需要占用一个**inode**(*255byte*)
- 空的目录会占用一个**block**大小(*约4k*)
	- block是基本的分配单位
	- 因为其必须默认带两个目录项"."和".."
- 目录的占用空间会包含文件名的大小
	- 也就是目录下的文件越多越长也会导致目录占用的大小
	- linux默认文件名长度限制255byte
- block
	- <font color=#81B300>文件block</font>
		- 只会保存文件数据，只要有文件数据都会至少分配一个block
	- <font color=#81B300>目录block</font>
		- 会保存很多文件系统的结构体
- 磁盘发起io也是以block size 为单位的

### linux IO栈
![[linux IO栈.png]]

####  IO引擎 - 用户层lib库

1.同步引擎
	- sync(数据一致性):
		- 数据写操作必须在所有目标节点收到确认后才认为完成。
	- psync（partial sync 可以局部复制同步）: 
		- 数据在执行重要事务时同步，而在高负载时期可能异步。
	- vsync（Volume sync）: 
		- 整个数据库卷会保持同步，包括所有数据文件和日志。
	- pvsync(Partial Volume Sync): 
		- 只在关键数据更新时进行同步，不包含次要数据的实时同步。

2.异步引擎
	- libaio:直接与内核交互
		- 直接利用Linux内核的异步I/O能力来提供高效的I/O操作
	- posixaio：跨平台，无依赖
		- 基于POSIX标准的异步I/O实现

3.存储映射
	- mmap：频繁访问文件/多进程共享数据
		- 将文件或者设备直接映射到进程的内存地址空间中，进程可以直接操作内存一样读写文件
		- **`mmap` 通过虚拟内存和页表机制，将文件数据映射到进程地址空间，实现类似内存操作的访问方式**

		 虚拟内存与页表
			- 每个进程都拥有独立的虚拟空间
			- 页表（page table）负责将虚拟地址映射到物理地址
		 文件映射
			- 调用mmap时，操作系统会在进程的虚拟地址空间中找一块空闲区域
			- 操作系统会建立虚拟页面和文件数据块之间的映射关系
			- 只是映射，没有加载文件数据
		 按需加载与返回
			 - 当进程访问映射的内存区域时，会触发缺页异常
			 - 操作系统捕获到异常后，会将对应的文件数据块加载到物理内存
			 - 并更新页表，将虚拟页面映射到加载数据的物理页面
			 - 当进程修改映射的内存数据，修改后的数据会先存入page cache
			 - 操作系统会随机将dirty page写回磁盘
		  多进程共享
			  - 操作系统为每个进程维护独立的页表，但指向相同的物理页面

![[io引擎.png]]

#### VFS文件映射系统

- superblock：Linux 用来标注具体已安装的文件系统的有关信息。
    
- inode：Linux 中的每一个文件/目录都有一个 inode，记录其权限、修改时间等信息。
    
- desty：目录项，是路径中的一部分，所有的目录项对象串起来就是一棵 Linux 下的目录树。
    
- file：文件对象，用来和打开它的进程进行交互。

围绕这这四个核心数据结构，VFS 也都定义了一系列的操作方法。
比如，inode 的操作方法定义 `inode_operations`，在它的里面定义了我们非常熟悉的 `mkdir` 和 `rename` 等。
对于 file 对象，定义了对应的操作方法 `file_operations`

#### PageCache

设置了 DIRECT_IO 标志，page cache不会生效

1. 当用户要访问文件的时候，如果访问文件的blcok在page cache组件将数据从内核态则直接拷贝到用户进程
2. 如果不存在，操作系统会处理缺页中断
	1. 缺页中断是由处理器硬件自动生成的缺页中断
	2. 分配新的页面
	3. 发起磁盘io
	4. 更新page cache
3. 完成数据访问，操作系统会将内核空间的page cache 拷贝到用户进程的内存空间

#### 文件系统
- Linux 下支持的文件系统有很多，常用的有 ext2/3/4、XFS、ZFS 等
#### 通用块层
#### IO调度层

