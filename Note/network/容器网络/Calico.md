##### 主要架构

1. etcd
    
2. Felix : 守护进程，负责刷新主机路由和ACL规则（iptables）
    
3. BGP client : 每个运行的Felix的节点都部署一个BGP，读取Felix编写到内核路由规则并进行分发
    
4. BGP Route Reflector : 路由器反射器
    

##### 报文路径

1. 为所有pod分配的mac地址一样（只关心三层）
    
2. 在容器内，所有的报文读会经过veth0发送到169.254.1.1（预留的本地ip网段）
    
3. 此时报文到达veth的对端设备veth1，这个设备会被随机分配一个mac地址，收到ARP请求之后直接进行应答，应答报文中的mac地址是自己的地址
    
4. 但是容器的后续报文的mac地址会变成该网卡eth1的地址，即所有的报文都会送给主机，主机再根据IP地址进行转发
    
5. 上述的这种行为成为arp proxy：不管ARP请求的内容，直接用自己的mac地址作为应答的行为
    
6. 可以理解为Calico把主机作为容器的默认网关使用。所有报文直接发到主机
    

##### 为什么使用BGP

1. BGP是一种简单的路由协议
    
2. 拥有行业最佳实践
    
3. 能够支撑大规模的路由规则并具有可扩展性
    

##### 为什么需要大二层

没有任何的三层网关，所有机器，宿主机，物理机在二层是可达的

1. 主要解决弹性伸缩的问题：在频繁开关机的时候，容器的启停虽然不影响交换机，但是容器产生广播风暴(因为在同一个网段)
    
2. 大二层存在单一故障问题，也就是说，任何一个都会有一定的硬件风险让整个大二层瘫痪。
    
3. 因此，实际场景经常会把集群划分成多个网段，对外是三层网络的结构。
    

##### 如何解决广播风暴：

1. 限制DHCP广播：将来自容器的 DHCP 请求转发到专门的 DHCP 服务器
    
2. 控制ARP广播
    
    1. 绑定静态ARP,避免频繁发送 ARP 请求。
        
    2. ARP安全机制：在交换机或路由器上启用 DHCP Snooping、Dynamic ARP Inspection 等 ARP 安全机制，防止 ARP 欺骗攻击和无效 ARP 请求。
        
3. 通过监控及时发现